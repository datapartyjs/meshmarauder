#!/usr/bin/env node
":" //# comment; exec /usr/bin/env node --input-type=module - "$@" < "$0"
import * as fs from 'fs'
import * as readline from 'readline'

import { parseInputPacket, CHANNELS } from '../src/utils.mjs'
import { LorapipeRawPacket } from '../src/lorapipe-raw-packet.mjs'

async function main() {
  console.log(process.argv)
  const fileName = process.argv[2]
  let fileStream
  
  if(!fileName){
    fileStream = process.stdin
  } else {
    
    fileStream = fs.createReadStream(fileName)
  }

  const rl = readline.createInterface({
    input: fileStream,
    crlfDelay: Infinity
  });
  // crlfDelay option to clean up CR LF to a one line break

  for await (const line of rl) {

    if(line.indexOf('RAW') != -1){
      let initial = parseInputPacket(line)

      if(initial == null){ continue }

      let { seen, rssi, snr, raw } = initial

      let pkt = new LorapipeRawPacket(seen, rssi, snr, raw, CHANNELS)

      console.log(JSON.stringify(pkt.toObject()))
    }
  }

}

main();